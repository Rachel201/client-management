{"version":3,"file":"withViewport.js","sourceRoot":"../src/","sources":["utilities/decorators/withViewport.tsx"],"names":[],"mappings":"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","sourcesContent":["import * as React from 'react';\nimport { BaseDecorator } from './BaseDecorator';\nimport {\n  findScrollableParent,\n  getRect,\n  createRef\n} from '../../Utilities';\n\nexport interface IViewport {\n  width: number;\n  height: number;\n}\n\nexport interface IWithViewportState {\n  viewport?: IViewport;\n}\n\nexport interface IWithViewportProps {\n  skipViewportMeasures?: boolean;\n}\n\nconst RESIZE_DELAY = 500;\nconst MAX_RESIZE_ATTEMPTS = 3;\n\nexport function withViewport<TProps extends { viewport?: IViewport }, TState>(ComposedComponent: (new (props: TProps, ...args: any[]) => React.Component<TProps, TState>)): any {\n\n  return class WithViewportComponent extends BaseDecorator<TProps, IWithViewportState> {\n    private _root = createRef<HTMLDivElement>();\n    private _resizeAttempts: number;\n\n    constructor(props: TProps) {\n      super(props);\n      this._resizeAttempts = 0;\n\n      this.state = {\n        viewport: {\n          width: 0,\n          height: 0\n        }\n      };\n    }\n\n    public componentDidMount(): void {\n      this._onAsyncResize = this._async.debounce(\n        this._onAsyncResize,\n        RESIZE_DELAY,\n        {\n          leading: false\n        });\n\n      this._events.on(window, 'resize', this._onAsyncResize);\n      const {\n        skipViewportMeasures\n      } = this.props as IWithViewportProps;\n      if (!skipViewportMeasures) {\n        this._updateViewport();\n      }\n    }\n\n    public componentWillUnmount(): void {\n      this._events.dispose();\n    }\n\n    public render(): JSX.Element {\n      const { viewport } = this.state;\n      const {\n        skipViewportMeasures\n      } = this.props as IWithViewportProps;\n      const isViewportVisible = skipViewportMeasures || (viewport!.width > 0 && viewport!.height > 0);\n\n      return (\n        <div className='ms-Viewport' ref={ this._root } style={ { minWidth: 1, minHeight: 1 } }>\n          { isViewportVisible && (\n            <ComposedComponent ref={ this._updateComposedComponentRef } viewport={ viewport } { ...this.props as any } />\n          ) }\n        </div>\n      );\n    }\n\n    public forceUpdate(): void {\n      this._updateViewport(true);\n    }\n\n    private _onAsyncResize(): void {\n      this._updateViewport();\n    }\n\n    /* Note: using lambda here because decorators don't seem to work in decorators. */\n    private _updateViewport = (withForceUpdate?: boolean) => {\n      const { viewport } = this.state;\n      const viewportElement = this._root.current;\n      const scrollElement = findScrollableParent(viewportElement);\n      const scrollRect = getRect(scrollElement);\n      const clientRect = getRect(viewportElement);\n      const updateComponent = () => {\n        if (withForceUpdate && this._composedComponentInstance) {\n          this._composedComponentInstance.forceUpdate();\n        }\n      };\n\n      const isSizeChanged = (\n        (clientRect && clientRect.width) !== viewport!.width ||\n        (scrollRect && scrollRect.height) !== viewport!.height);\n\n      if (isSizeChanged && this._resizeAttempts < MAX_RESIZE_ATTEMPTS && clientRect && scrollRect) {\n        this._resizeAttempts++;\n        this.setState({\n          viewport: {\n            width: clientRect.width,\n            height: scrollRect.height\n          }\n        }, () => { this._updateViewport(withForceUpdate); });\n      } else {\n        this._resizeAttempts = 0;\n        updateComponent();\n      }\n    }\n  };\n}\n"]}