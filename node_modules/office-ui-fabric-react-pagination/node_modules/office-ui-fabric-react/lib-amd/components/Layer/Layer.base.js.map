{"version":3,"file":"Layer.base.js","sourceRoot":"../src/","sources":["components/Layer/Layer.base.tsx"],"names":[],"mappings":"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","sourcesContent":["/* tslint:disable:no-unused-variable */\nimport * as React from 'react';\nimport * as ReactDOM from 'react-dom';\n/* tslint:enable:no-unused-variable */\n\nimport { Fabric } from '../../Fabric';\nimport {\n  ILayerProps,\n  ILayerStyleProps,\n  ILayerStyles,\n} from './Layer.types';\nimport {\n  BaseComponent,\n  classNamesFunction,\n  customizable,\n  getDocument,\n  setVirtualParent,\n  createRef\n} from '../../Utilities';\n\nconst _layersByHostId: { [hostId: string]: LayerBase[] } = {};\nlet _defaultHostSelector: string | undefined;\n\nconst getClassNames = classNamesFunction<ILayerStyleProps, ILayerStyles>();\n\n@customizable('Layer', ['theme', 'hostId'])\nexport class LayerBase extends BaseComponent<ILayerProps, {}> {\n\n  public static defaultProps: ILayerProps = {\n    onLayerDidMount: () => undefined,\n    onLayerWillUnmount: () => undefined\n  };\n\n  private _rootElement = createRef<HTMLDivElement>();\n  private _host: Node;\n  private _layerElement: HTMLElement | undefined;\n  private _hasMounted: boolean;\n  /**\n   * Used for notifying applicable Layers that a host is available/unavailable and to re-evaluate Layers that\n   * care about the specific host.\n   */\n  public static notifyHostChanged(id: string) {\n    if (_layersByHostId[id]) {\n      _layersByHostId[id].forEach(layer => layer.forceUpdate());\n    }\n  }\n\n  /**\n   * Sets the default target selector to use when determining the host in which\n   * Layered content will be injected into. If not provided, an element will be\n   * created at the end of the document body.\n   *\n   * Passing in a falsey value will clear the default target and reset back to\n   * using a created element at the end of document body.\n   */\n  public static setDefaultTarget(selector?: string) {\n    _defaultHostSelector = selector;\n  }\n\n  constructor(props: ILayerProps) {\n    super(props);\n\n    this._warnDeprecations({\n      onLayerMounted: 'onLayerDidMount'\n    });\n\n    if (this.props.hostId) {\n      if (!_layersByHostId[this.props.hostId]) {\n        _layersByHostId[this.props.hostId] = [];\n      }\n\n      _layersByHostId[this.props.hostId].push(this);\n    }\n  }\n\n  public componentDidMount(): void {\n    this.componentDidUpdate();\n  }\n\n  public componentWillUnmount(): void {\n    this._removeLayerElement();\n\n    if (this.props.hostId) {\n      _layersByHostId[this.props.hostId] = _layersByHostId[this.props.hostId].filter(layer => layer !== this);\n      if (!_layersByHostId[this.props.hostId].length) {\n        delete _layersByHostId[this.props.hostId];\n      }\n    }\n  }\n\n  public componentDidUpdate(): void {\n    const host = this._getHost();\n\n    const { className, getStyles, theme } = this.props;\n    const classNames = getClassNames(getStyles!,\n      {\n        theme: theme!,\n        className,\n        isNotHost: !this.props.hostId\n      }\n    );\n\n    if (host !== this._host) {\n      this._removeLayerElement();\n    }\n\n    if (host) {\n      this._host = host;\n\n      if (!this._layerElement) {\n        const rootElement = this._rootElement.current;\n        const doc = getDocument(rootElement);\n\n        if (!doc || !rootElement) {\n          return;\n        }\n\n        this._layerElement = doc.createElement('div');\n        this._layerElement.className = classNames.root!;\n\n        host.appendChild(this._layerElement);\n        setVirtualParent(this._layerElement, rootElement);\n      }\n\n      // Using this 'unstable' method allows us to retain the React context across the layer projection.\n      ReactDOM.unstable_renderSubtreeIntoContainer(\n        this,\n        (\n          <Fabric className={ classNames.content }>\n            { this.props.children }\n          </Fabric>\n        ),\n        this._layerElement,\n        () => {\n          if (!this._hasMounted) {\n            this._hasMounted = true;\n\n            // TODO: @deprecated cleanup required.\n            if (this.props.onLayerMounted) {\n              this.props.onLayerMounted();\n            }\n\n            this.props.onLayerDidMount!();\n          }\n        });\n    }\n  }\n\n  public render(): JSX.Element {\n    return (\n      <span\n        className='ms-Layer'\n        ref={ this._rootElement }\n      />\n    );\n  }\n\n  private _removeLayerElement(): void {\n    if (this._layerElement) {\n      this.props.onLayerWillUnmount!();\n\n      ReactDOM.unmountComponentAtNode(this._layerElement);\n      const parentNode = this._layerElement.parentNode;\n      if (parentNode) {\n        parentNode.removeChild(this._layerElement);\n      }\n      this._layerElement = undefined;\n      this._hasMounted = false;\n    }\n  }\n\n  private _getHost(): Node | undefined {\n    const { hostId } = this.props;\n    const doc = getDocument(this._rootElement.current);\n\n    if (!doc) {\n      return undefined;\n    }\n\n    if (hostId) {\n      return doc.getElementById(hostId) as Node;\n    } else {\n      return _defaultHostSelector ? doc.querySelector(_defaultHostSelector) as Node : doc.body;\n    }\n  }\n\n}\n"]}