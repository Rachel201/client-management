{"version":3,"file":"VirtualizedList.js","sourceRoot":"../src/","sources":["components/VirtualizedList/VirtualizedList.tsx"],"names":[],"mappings":"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","sourcesContent":["import * as React from 'react';\nimport { IVirtualizedListProps } from './VirtualizedList.types';\nimport { IScrollContainerContext, ScrollContainerContextTypes } from '../../utilities/scrolling/ScrollContainer';\nimport { IObjectWithKey } from 'office-ui-fabric-react/lib/Selection';\nimport { getParent, css, initializeComponentRef, EventGroup } from 'office-ui-fabric-react/lib/Utilities';\n\ninterface IRange {\n  /** Start of range */\n  start: number;\n\n  /** Exclusive end of range */\n  end: number;\n}\n\nfunction isInRange(range: IRange, index: number): boolean {\n  return range.start <= index && index < range.end;\n}\n\nexport interface IVirtualizedListState {\n  viewportHeight: number;\n\n  items: React.ReactNode[];\n}\n\nexport class VirtualizedList<TItem extends IObjectWithKey> extends React.Component<\n  IVirtualizedListProps<TItem>,\n  IVirtualizedListState\n> {\n  public static contextTypes: typeof ScrollContainerContextTypes = ScrollContainerContextTypes;\n  public context: IScrollContainerContext;\n\n  private _root = React.createRef<HTMLDivElement>();\n\n  private _spacerElements: { [key: string]: HTMLElement } = {};\n\n  private _focusedIndex: number;\n\n  private _events: EventGroup;\n\n  constructor(props: IVirtualizedListProps<TItem>, context: IScrollContainerContext) {\n    super(props, context);\n\n    this._events = new EventGroup(this);\n    initializeComponentRef(this);\n\n    this._focusedIndex = -1;\n\n    const {\n      // Start with the window height if not passed in props, this does not cause layout\n      initialViewportHeight = window.innerHeight,\n    } = this.props;\n\n    this.state = {\n      viewportHeight: initialViewportHeight,\n      items: this._renderItems(0, initialViewportHeight),\n    };\n  }\n\n  public componentDidMount(): void {\n    if (this._root.current) {\n      this._events.on(this._root.current, 'focus', this._onFocus, true);\n    }\n\n    this.context.scrollContainer.registerVisibleCallback((scrollTop: number) => {\n      this._render(scrollTop);\n    });\n\n    this._updateObservedElements();\n  }\n\n  public componentDidUpdate(): void {\n    this._updateObservedElements();\n  }\n\n  public componentWillUnmount(): void {\n    this._events.dispose();\n  }\n\n  public UNSAFE_componentWillUpdate(): void {\n    for (const key of Object.keys(this._spacerElements)) {\n      const ref = this._spacerElements[key];\n      this.context.scrollContainer.unobserve(ref);\n    }\n  }\n\n  public render(): JSX.Element {\n    const { className } = this.props;\n    const { items } = this.state;\n\n    return (\n      <div className={css('ms-VirtualizedList', className)} ref={this._root}>\n        {items}\n      </div>\n    );\n  }\n\n  private _updateObservedElements(): void {\n    // (Re-)register with the observer after every update, so we'll get an intersection event immediately if one of\n    // the spacer elements is visible right now.\n    for (const key of Object.keys(this._spacerElements)) {\n      const ref = this._spacerElements[key];\n      this.context.scrollContainer.observe(ref);\n    }\n  }\n\n  private _renderItems(scrollTop: number, viewportHeight: number): (JSX.Element | null)[] {\n    const { itemHeight, items, itemOverdraw = 2 } = this.props;\n\n    const ranges: IRange[] = [];\n\n    // Calculate visible range\n    const startIndex = Math.floor(Math.max(scrollTop / itemHeight - itemOverdraw, 0));\n    const endIndex = Math.floor(Math.min(startIndex + itemOverdraw * 2 + viewportHeight / itemHeight, items.length));\n\n    const visibleRange = {\n      start: startIndex,\n      end: endIndex,\n    };\n\n    ranges.push(visibleRange);\n\n    // Focused item\n    if (this._focusedIndex !== -1 && !isInRange(visibleRange, this._focusedIndex)) {\n      const focusRange: IRange = {\n        start: this._focusedIndex,\n        end: this._focusedIndex + 1,\n      };\n\n      if (this._focusedIndex < visibleRange.start) {\n        ranges.unshift(focusRange);\n      } else {\n        ranges.push(focusRange);\n      }\n    }\n\n    return this._renderRanges(ranges);\n  }\n\n  private _renderRanges(ranges: IRange[]): (JSX.Element | null)[] {\n    const { items, onRenderItem } = this.props;\n    const result: (JSX.Element | null)[] = [];\n\n    // Assume ranges are sorted.\n\n    let lastRenderedIndex = -1;\n\n    for (const range of ranges) {\n      // Spacer item before range or between the last range and this one\n      const isFirstRange = lastRenderedIndex === -1;\n      if ((isFirstRange && range.start !== 0) || (!isFirstRange && lastRenderedIndex !== range.start)) {\n        // Last range is not continuous with this one,\n        // or the first range does not start from the beginning: insert spacer item\n        const spacerStartIndex = isFirstRange ? 0 : lastRenderedIndex;\n        const gapBetweenRanges = range.start - spacerStartIndex;\n        if (gapBetweenRanges > 0) {\n          result.push(this._renderSpacerItem(gapBetweenRanges, spacerStartIndex));\n        }\n      }\n\n      for (let i = range.start; i < range.end; ++i) {\n        result.push(onRenderItem(items[i], i));\n      }\n\n      lastRenderedIndex = range.end - 1;\n    }\n\n    // Insert final spacer item\n    const itemCount = (items || []).length;\n    if (lastRenderedIndex < itemCount - 1) {\n      result.push(this._renderSpacerItem(itemCount - lastRenderedIndex, lastRenderedIndex));\n    }\n\n    return result;\n  }\n\n  private _renderSpacerItem(numberOfItems: number, index: number): JSX.Element {\n    const { itemHeight, items = [], spacerItemTagName: ItemTag = 'div' } = this.props;\n\n    const spacerHeight = numberOfItems * itemHeight;\n    const itemCount = items.length;\n\n    let key: string;\n    if (index === 0) {\n      key = `spacer-start`;\n    } else if (index + numberOfItems === itemCount) {\n      key = `spacer-end`;\n    } else {\n      key = `spacer-item-${index + numberOfItems}`;\n    }\n\n    return React.createElement(ItemTag, { ref: this._spacerRef.bind(this, key), key, style: { height: spacerHeight } });\n  }\n\n  private _spacerRef = (key: string, ref: HTMLElement): void => {\n    if (ref) {\n      this._spacerElements[key] = ref;\n    } else {\n      delete this._spacerElements[key];\n    }\n  };\n\n  private _render(scrollTop: number): void {\n    scrollTop = Math.floor(scrollTop);\n\n    this.setState({\n      items: this._renderItems(scrollTop, this.state.viewportHeight),\n    });\n  }\n\n  private _onFocus(ev: React.FocusEvent<HTMLDivElement>): void {\n    let target = ev.target as HTMLElement;\n\n    while (target !== this._root.current) {\n      const indexString = target.getAttribute('data-selection-index');\n\n      if (indexString) {\n        this._focusedIndex = Number(indexString);\n        break;\n      }\n\n      target = getParent(target) as HTMLElement;\n    }\n  }\n}\n"]}